<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Practice Quiz</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        :root { --primary-color: #1A73E8; --bg-color: #F7F9FC; }
        body { background-color: var(--bg-color); font-family: 'Inter', sans-serif; }
        .quiz-container { max-width: 800px; margin: 2rem auto; background: #fff; padding: 2rem; border-radius: 16px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .name-container { text-align: center; }
        .question { margin-bottom: 1.5rem; }
        .options .form-check { margin-bottom: 0.5rem; }
        .timer { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); }
    </style>
</head>
<body>

<!-- Name Input Section -->
<div id="name-section" class="d-flex align-items-center justify-content-center min-vh-100">
    <div class="name-container card p-4 p-md-5 text-center">
        <h1 class="mb-3">IELTS Practice Quiz</h1>
        <p class="text-muted mb-4">Please enter your full name to begin.</p>
        <div class="form-floating mb-3">
            <input type="text" class="form-control" id="student-name-input" placeholder="Your Name">
            <label for="student-name-input">Name (CAPITAL LETTERS)</label>
        </div>
        <button id="start-quiz-btn" class="btn btn-primary btn-lg w-100">Start Quiz</button>
        <div id="name-error" class="text-danger mt-2" style="display: none;">Name is required.</div>
    </div>
</div>

<!-- Quiz Section -->
<div id="quiz-section" class="quiz-container" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 id="quiz-title">Writing Task 1 Quiz</h2>
        <div id="timer" class="timer">04:00</div>
    </div>

    <div id="quiz-questions">
        <!-- Questions will be dynamically inserted here -->
    </div>

    <button id="submit-quiz-btn" class="btn btn-success btn-lg w-100 mt-4">Submit Answers</button>
</div>

<!-- Thank You Section -->
<div id="thank-you-section" class="d-flex align-items-center justify-content-center min-vh-100" style="display: none;">
    <div class="text-center">
        <h1>Thank You!</h1>
        <p class="lead">Your results have been submitted.</p>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // --- Firebase Config ---
    const firebaseConfig = {
        apiKey: "AIzaSy***Q",
        authDomain: "ielts-live-dashboard.firebaseapp.com",
        databaseURL: "https://ielts-live-dashboard-default-rtdb.firebaseio.com",
        projectId: "ielts-live-dashboard",
        storageBucket: "ielts-live-dashboard.appspot.com",
        messagingSenderId: "1044694021318",
        appId: "1:1044694021318:web:70f1ac1ba0787d37da93c7",
        measurementId: "G-R9G2YGSBM9"
    };

    // --- Initialize Firebase ---
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    // --- DOM Elements ---
    const nameSection = document.getElementById('name-section');
    const quizSection = document.getElementById('quiz-section');
    const thankYouSection = document.getElementById('thank-you-section');
    const studentNameInput = document.getElementById('student-name-input');
    const startQuizBtn = document.getElementById('start-quiz-btn');
    const nameError = document.getElementById('name-error');
    const submitQuizBtn = document.getElementById('submit-quiz-btn');
    const timerEl = document.getElementById('timer');

    // --- State ---
    let studentName = '';
    let startTime;
    let timerInterval;
    const quizDuration = 4 * 60; // 4 minutes in seconds

    // --- Dummy Quiz Data ---
    const quizData = {
        id: 'task1',
        title: 'Writing Task 1 Quiz',
        questions: [
            { q: "What is the primary purpose of an introduction in Task 1?", o: ["To give your opinion", "To paraphrase the question", "To list all key features"], a: "To paraphrase the question" },
            { q: "Should you include a conclusion in Task 1?", o: ["Always", "Never", "Only for maps"], a: "Never" },
            { q: "What is a 'trend'?", o: ["A single data point", "A general direction or movement", "A comparison between two charts"], a: "A general direction or movement" },
            // Add 12 more questions to make it 15
            ...Array.from({ length: 12 }, (_, i) => ({ q: `Sample Question ${i + 4}`, o: [`Option A${i}`, `Option B${i}`, `Option C${i}`], a: `Option A${i}` }))
        ]
    };

    // --- Event Listeners ---
    studentNameInput.addEventListener('input', (e) => {
        e.target.value = e.target.value.toUpperCase();
    });

    startQuizBtn.addEventListener('click', () => {
        studentName = studentNameInput.value.trim();
        if (studentName) {
            nameError.style.display = 'none';
            startQuiz();
        } else {
            nameError.style.display = 'block';
        }
    });

    submitQuizBtn.addEventListener('click', () => {
        submitQuiz();
    });

    // --- Functions ---
    function startQuiz() {
        nameSection.style.display = 'none';
        quizSection.style.display = 'block';
        startTime = Date.now();
        // Set initial status in Firebase
        const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
        set(ref(db, `status/${studentName}`), {
            status: 'attempting',
            startTime: serverTimestamp()
        });

        loadQuestions();
        startTimer();
    }

    function loadQuestions() {
        const questionsContainer = document.getElementById('quiz-questions');
        let questionsHTML = '';
        quizData.questions.forEach((q, index) => {
            questionsHTML += `
                <div class="question" id="q-${index}">
                    <p class="fw-bold">${index + 1}. ${q.q}</p>
                    <div class="options">
                        ${q.o.map(option => `
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="q${index}" id="q${index}-${option}" value="${option}">
                                <label class="form-check-label" for="q${index}-${option}">${option}</label>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        });
        questionsContainer.innerHTML = questionsHTML;
    }

    function startTimer() {
        let timeLeft = quizDuration;
        timerInterval = setInterval(() => {
            timeLeft--;
            const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const seconds = (timeLeft % 60).toString().padStart(2, '0');
            timerEl.textContent = `${minutes}:${seconds}`;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                submitQuiz(); // Auto-submit when time is up
            }
        }, 1000);
    }

    function getDeviceInfo() {
        const ua = navigator.userAgent;
        let os = "Unknown OS";
        if (ua.indexOf("Win") != -1) os = "Windows";
        if (ua.indexOf("Mac") != -1) os = "MacOS";
        if (ua.indexOf("Linux") != -1) os = "Linux";
        if (ua.indexOf("Android") != -1) os = "Android";
        if (ua.indexOf("like Mac") != -1) os = "iOS";

        let browser = "Unknown Browser";
        if (ua.indexOf("Firefox") > -1) browser = "Firefox";
        if (ua.indexOf("Chrome") > -1) browser = "Chrome";
        if (ua.indexOf("Safari") > -1 && ua.indexOf("Chrome") == -1) browser = "Safari";

        const deviceType = /Mobi|Android/i.test(ua) ? "Mobile" : "Laptop/Desktop";
        return { os, browser, deviceType };
    }

    function submitQuiz() {
        clearInterval(timerInterval);
        const endTime = Date.now();
        const timeTaken = Math.round((endTime - startTime) / 1000); // in seconds
        const totalQuestions = quizData.questions.length;

        let correct = 0;
        let incorrect = 0;
        let missed = 0;
        const wrongAnswers = {}; // For analytics

        quizData.questions.forEach((q, index) => {
            const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
            if (selectedOption) {
                if (selectedOption.value === q.a) {
                    correct++;
                } else {
                    incorrect++;
                    wrongAnswers[index + 1] = selectedOption.value; // Store wrong answer
                }
            } else {
                missed++;
            }
        });

        const score = `${correct}/${totalQuestions}`;
        const accuracy = totalQuestions > 0 ? (correct / totalQuestions) * 100 : 0;
        const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

        const submissionData = {
            studentName,
            taskId: quizData.id,
            score,
            correct,
            incorrect,
            missed,
            accuracy: parseFloat(accuracy.toFixed(2)),
            timeTaken, // seconds
            submittedAt: serverTimestamp(),
            deviceInfo: getDeviceInfo(),
            wrongAnswers // e.g., { "1": "To give your opinion", "5": "Option C" }
        };

        // 1. Send to /liveSubmissions
        const newSubmissionRef = push(ref(db, 'liveSubmissions'));
        set(newSubmissionRef, submissionData);

        // 2. Send to /status
        set(ref(db, `status/${studentName}`), {
            status: 'submitted',
            score: score,
            submittedAt: serverTimestamp()
        });

        // 3. Send to /timeline
        const timelineEntry = {
            message: `${studentName} submitted (${score})`,
            timestamp: serverTimestamp()
        };
        push(ref(db, `timeline/${today}`), timelineEntry);

        // 4. Send to /archive
        push(ref(db, `archive/${today}/submissions`), submissionData);

        // TODO: Send to /analytics (This requires more complex transaction logic server-side or via cloud functions for aggregation)

        quizSection.style.display = 'none';
        thankYouSection.style.display = 'block';
    }

</script>
</body>
</html>
    