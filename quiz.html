<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Practice Quiz</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Inter:wght@400;500&display=swap" rel="stylesheet">
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        :root {
            --primary-color: #1A73E8;
            --secondary-color: #0D1B2A;
            --accent-green: #00A884;
            --danger-color: #dc3545;
            --bg-color: #F7F9FC;
            --text-color: #303030;
            --card-bg: #FFFFFF;
        }

        body {
            background-color: var(--bg-color);
            font-family: 'Inter', sans-serif;
            color: var(--text-color);
        }

        h1, h2, h3 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            color: var(--secondary-color);
        }

        .card {
            border: none;
            border-radius: 16px;
            background: var(--card-bg);
            box-shadow: 0 8px 25px rgba(0,0,0,0.07);
            padding: 2rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            font-weight: 700;
        }

        /* Name Input Section */
        #name-section .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
        }
        #name-section h1 { color: #fff; }
        #name-section p { color: rgba(255, 255, 255, 0.8); }

        /* Quiz Container */
        .quiz-container {
            max-width: 800px;
            margin: 2rem auto;
        }

        .timer {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .question {
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .options .form-check-label {
            display: block;
            width: 100%;
            padding: 0.75rem 1.25rem;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .options .form-check-label:hover {
            background-color: #f8f9fa;
            border-color: var(--primary-color);
        }
        .options .form-check-input {
            display: none; /* Hide the actual radio button */
        }
        .correct {
            background-color: #d1e7dd !important;
            border-color: var(--accent-green) !important;
            font-weight: bold;
        }
        .wrong {
            background-color: #f8d7da !important;
            border-color: var(--danger-color) !important;
        }
        .correct::before { content: '✔ '; color: var(--accent-green); }
        .wrong::before { content: '✖ '; color: var(--danger-color); }
        .btn-info {
            background-color: #0dcaf0;
            border-color: #0dcaf0;
            color: white;
            font-weight: 700;
        }
    </style>
</head>
<body>

<!-- Name Input Section -->
<div id="name-section" class="d-flex align-items-center justify-content-center min-vh-100" style="background: var(--secondary-color);">
    <div class="card text-center p-4 p-md-5" style="max-width: 450px;">
        <h1 class="mb-3">IELTS Practice Quiz</h1>
        <p class="text-muted mb-4">Please enter your full name to begin.</p>
        <div class="form-floating mb-3">
            <input type="text" class="form-control" id="student-name-input" placeholder="Your Name">
            <label for="student-name-input">Name (CAPITAL LETTERS)</label>
        </div>
        <button id="start-quiz-btn" class="btn btn-primary btn-lg w-100">Start Quiz</button>
        <div id="name-error" class="text-danger mt-2" style="display: none;">Name is required.</div>
    </div>
</div>

<!-- Quiz Section -->
<div id="quiz-section" class="quiz-container card" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 id="quiz-title">Writing Task 1 Quiz</h2>
        <div id="timer" class="timer">04:00</div>
    </div>

    <div id="quiz-questions">
        <!-- Questions will be dynamically inserted here -->
    </div>

    <button id="submit-quiz-btn" class="btn btn-success btn-lg w-100 mt-4">Submit Answers</button>
</div>

<!-- Result Section -->
<div id="result-section" class="quiz-container card text-center" style="display: none;">
    <h2 id="score-display"></h2>
    <p class="lead">Your results have been submitted. Review your answers above.</p>
    <div class="mt-4">
        <a href="materials/week21-wt2pdf.pdf" id="downloadBtn" class="btn btn-info" download>Download Grammar PDF Guide</a>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // --- Firebase Config ---
    const firebaseConfig = {
        apiKey: "AIzaSy***Q",
        authDomain: "ielts-live-dashboard.firebaseapp.com",
        databaseURL: "https://ielts-live-dashboard-default-rtdb.firebaseio.com",
        projectId: "ielts-live-dashboard",
        storageBucket: "ielts-live-dashboard.appspot.com",
        messagingSenderId: "1044694021318",
        appId: "1:1044694021318:web:70f1ac1ba0787d37da93c7",
        measurementId: "G-R9G2YGSBM9"
    };

    // --- Initialize Firebase ---
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    // --- DOM Elements ---
    const nameSection = document.getElementById('name-section');
    const quizSection = document.getElementById('quiz-section');
    const resultSection = document.getElementById('result-section');
    const studentNameInput = document.getElementById('student-name-input');
    const startQuizBtn = document.getElementById('start-quiz-btn');
    const nameError = document.getElementById('name-error');
    const submitQuizBtn = document.getElementById('submit-quiz-btn');
    const timerEl = document.getElementById('timer');

    // --- State ---
    let studentName = '';
    let startTime;
    let timerInterval;
    const quizDuration = 4 * 60; // 4 minutes in seconds

    // --- Dummy Quiz Data ---
    const quizData = {
        id: 'task1',
        title: 'IELTS Grammar Quiz',
        questions: [
            { q: "If he ____ earlier, he wouldn’t have missed the train.", o: ["leaves", "had left", "left", "would leave"], a: "had left" },
            { q: "I look forward to ____ from you soon.", o: ["hear", "hearing", "be hearing", "have heard"], a: "hearing" },
            { q: "She didn’t mind ____ alone in the office.", o: ["to work", "work", "working", "worked"], a: "working" },
            { q: "By the time we arrived, the meeting ____.", o: ["has already started", "already starts", "had already started", "already started"], a: "had already started" },
            { q: "He is ____ honest man.", o: ["a", "the", "an", "no article needed"], a: "an" },
            { q: "Neither of the answers ____ correct.", o: ["are", "were", "is", "be"], a: "is" },
            { q: "The more you practise, the ____ you become.", o: ["confident", "more confident", "most confident", "confidently"], a: "more confident" },
            { q: "She asked me ____ the door.", o: ["to close", "close", "closing", "to closing"], a: "to close" },
            { q: "If it ____ tomorrow, we will cancel the trip.", o: ["rains", "will rain", "rained", "is raining"], a: "rains" },
            { q: "The project ____ by the end of this month.", o: ["has completed", "will be completed", "is completing", "completed"], a: "will be completed" }
        ]
    };

    // --- Event Listeners ---
    studentNameInput.addEventListener('input', (e) => {
        e.target.value = e.target.value.toUpperCase();
    });

    startQuizBtn.addEventListener('click', () => {
        studentName = studentNameInput.value.trim();
        if (studentName) {
            nameError.style.display = 'none';
            startQuiz();
        } else {
            nameError.style.display = 'block';
        }
    });

    submitQuizBtn.addEventListener('click', () => {
        submitQuiz();
    });

    // --- Functions ---
    function startQuiz() {
        nameSection.style.display = 'none';
        quizSection.style.display = 'block';
        startTime = Date.now();
        // Set initial status in Firebase
        const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
        set(ref(db, `status/${studentName}`), {
            status: 'attempting',
            startTime: serverTimestamp()
        });

        loadQuestions();
        startTimer();
    }

    function loadQuestions() {
        const questionsContainer = document.getElementById('quiz-questions');
        let questionsHTML = '';
        quizData.questions.forEach((q, index) => {
            questionsHTML += `
                <div class="question" id="q-${index}">
                    <p class="fw-bold">${index + 1}. ${q.q}</p>
                    <div class="options">
                        ${q.o.map(option => `
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="q${index}" id="q${index}-${option}" value="${option}" autocomplete="off">
                                <label class="form-check-label" for="q${index}-${option}">${option}</label>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        });
        questionsContainer.innerHTML = questionsHTML;
    }

    function startTimer() {
        let timeLeft = quizDuration;
        timerInterval = setInterval(() => {
            timeLeft--;
            const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const seconds = (timeLeft % 60).toString().padStart(2, '0');
            timerEl.textContent = `${minutes}:${seconds}`;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                submitQuiz(); // Auto-submit when time is up
            }
        }, 1000);
    }

    function getDeviceInfo() {
        const ua = navigator.userAgent;
        let os = "Unknown OS";
        if (ua.indexOf("Win") != -1) os = "Windows";
        if (ua.indexOf("Mac") != -1) os = "MacOS";
        if (ua.indexOf("Linux") != -1) os = "Linux";
        if (ua.indexOf("Android") != -1) os = "Android";
        if (ua.indexOf("like Mac") != -1) os = "iOS";

        let browser = "Unknown Browser";
        if (ua.indexOf("Firefox") > -1) browser = "Firefox";
        if (ua.indexOf("Chrome") > -1) browser = "Chrome";
        if (ua.indexOf("Safari") > -1 && ua.indexOf("Chrome") == -1) browser = "Safari";

        const deviceType = /Mobi|Android/i.test(ua) ? "Mobile" : "Laptop/Desktop";
        return { os, browser, deviceType };
    }

    function submitQuiz() {
        clearInterval(timerInterval);
        const endTime = Date.now();
        const timeTaken = Math.round((endTime - startTime) / 1000); // in seconds
        const totalQuestions = quizData.questions.length;

        let correct = 0;
        let incorrect = 0;
        let missed = 0;
        const wrongAnswers = {}; // For analytics

        quizData.questions.forEach((q, index) => {
            const selectedOption = document.querySelector(`input[name="q${index}"]:checked`);
            if (selectedOption) {
                if (selectedOption.value === q.a) {
                    correct++;
                } else {
                    incorrect++;
                    wrongAnswers[index + 1] = selectedOption.value; // Store wrong answer
                }
            } else {
                missed++;
            }
        });

        const score = `${correct}/${totalQuestions}`;
        const accuracy = totalQuestions > 0 ? (correct / totalQuestions) * 100 : 0;
        const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

        const submissionData = {
            studentName,
            taskId: quizData.id,
            score,
            correct,
            incorrect,
            missed,
            accuracy: parseFloat(accuracy.toFixed(2)),
            timeTaken, // seconds
            submittedAt: serverTimestamp(),
            deviceInfo: getDeviceInfo(),
            wrongAnswers // e.g., { "1": "To give your opinion", "5": "Option C" }
        };

        // 1. Send to /liveSubmissions
        const newSubmissionRef = push(ref(db, 'liveSubmissions'));
        set(newSubmissionRef, submissionData);

        // 2. Send to /status
        set(ref(db, `status/${studentName}`), {
            status: 'submitted',
            score: score,
            submittedAt: serverTimestamp()
        });

        // 3. Send to /timeline
        const timelineEntry = {
            message: `${studentName} submitted (${score})`,
            timestamp: serverTimestamp()
        };
        push(ref(db, `timeline/${today}`), timelineEntry);

        // 4. Send to /archive
        push(ref(db, `archive/${today}/submissions`), submissionData);

        // TODO: Send to /analytics (This requires more complex transaction logic server-side or via cloud functions for aggregation)

        // --- Show results to the student ---
        document.getElementById('score-display').textContent = `Your Score: ${correct} / ${totalQuestions}`;
        
        quizData.questions.forEach((q, index) => {
            const options = document.querySelectorAll(`input[name="q${index}"]`);
            options.forEach(optionRadio => {
                const label = optionRadio.closest('.form-check');
                // If an incorrect option was selected, highlight it as wrong
                if (optionRadio.checked && optionRadio.value !== q.a) {
                    label.classList.add('wrong');
                }
                // Highlight the correct answer
                if (optionRadio.value === q.a) {
                    label.classList.add('correct');
                }
                // Disable all inputs
                optionRadio.disabled = true;
            });
        });

        resultSection.style.display = 'block';
        submitQuizBtn.style.display = 'none'; // Hide submit button
        resultSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

</script>
</body>
</html>
    